<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }} - Мой Магазин</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css">
    <style>
        :root {
            --backgroundSecondary: #ffffff;
            --backgroundBottomBar: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --buttonBgPrimary: #1a1a1a;
            --buttonBgPrimaryAccented: #333333;
            --iconPrimary: #1a1a1a;
            --icon-on-color-enabled: #ffffff;
        }

        .ProductPage {
            background: var(--backgroundSecondary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 72px;
        }

        .sectionContainer {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 0 20px;
            background: #f8f8f8;
        }

        .PDPImageSwiper {
            width: 100%;
            height: 100%;
            min-height: 400px;
            background: #f8f8f8;
        }

        .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .swiper-pagination {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .swiper-pagination-bullet {
            width: 10px;
            height: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            margin: 0 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .swiper-pagination-bullet-active {
            background: #1a1a1a;
            transform: scale(1.2);
        }

        .share {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 50;
            transition: all 0.3s ease;
        }

        .share:hover {
            background: rgba(0, 0, 0, 0.4);
            transform: scale(1.05);
        }

        .ProductPage_container {
            background: #fff;
            padding: 24px;
            margin: 0 20px;
            border-radius: 0;
            box-shadow: none;
            border: none;
        }

        .PDPAttributeContainer {
            margin-top: -20px;
            position: relative;
        }

        .attribute-group {
            margin-bottom: 20px;
        }

        .attribute-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: inline;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            padding: 4px 8px;
        }

        .attribute-value {
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 12px;
            display: inline;
        }

        .attribute-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .option-button {
            padding: 8px 16px;
            border: none;
            border-radius: 0;
            background: #fff;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .option-button:hover {
            border-color: #666666;
        }

        .option-button.selected {
            border-color: #000000;
            background: #000000;
            color: #fff;
        }

        .option-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .product-title {
            font-size: 19px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .product-price {
            font-size: 22px !important;
            font-weight: 700 !important;
            color: var(--text-primary) !important;
            margin-bottom: 20px !important;
        }

        .product-description {
            margin-bottom: 20px;
        }

        .description-title {
            font-size: 14px;
            font-weight: 600;
            color: #666666;
            margin-bottom: 12px;
        }

        .description-content {
            font-size: 14px;
            color: #000000;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .read-more {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #007bff;
            cursor: pointer;
            font-size: 14px;
            margin-top: 8px;
        }

        .support-section {
            text-align: center;
        }

        .support-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .support-button {
            background: #f0f0f0;
            color: #666666;
            border: none;
            padding: 16px 20px;
            border-radius: 0;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bottomButtonWrapper_tdesktop {
            background: var(--backgroundBottomBar);
            padding: 16px;
            border-top: none;
            position: sticky;
            bottom: 0;
        }

        .add-to-cart-button {
            background: var(--buttonBgPrimary);
            color: #fff;
            border: none;
            padding: 18px 24px;
            border-radius: 0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: none;
        }

        .add-to-cart-button:hover {
            background: var(--buttonBgPrimaryAccented);
            transform: translateY(-2px);
            box-shadow: none;
        }

        .add-to-cart-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }





        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 8px;
            text-align: center;
        }

        .success-message {
            color: #28a745;
            font-size: 14px;
            margin-top: 8px;
            text-align: center;
        }

        .product-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            line-height: 1.3;
            margin-bottom: 8px;
        }

        .product-price {
            font-size: 22px !important;
            font-weight: 700 !important;
            color: var(--text-primary) !important;
            font-family: 'Inter', sans-serif !important;
        }

        .description-title {
            font-size: 16px;
            font-weight: 600;
            color: #666666;
            font-family: 'Inter', sans-serif;
            margin-bottom: 12px;
        }

        .description-content {
            font-size: 16px;
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }

        .option-button {
            background: #f8f8f8;
            border: none;
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .option-button:hover {
            background: #f0f0f0;
            border-color: #1a1a1a;
        }

        .option-button.selected {
            background: #1a1a1a;
            color: #ffffff;
            border-color: #1a1a1a;
        }

        @media (max-width: 768px) {
            .PDPImageSwiper {
                height: 600px;
            }
            
            .ProductPage_container {
                margin: 0 12px;
                padding: 16px;
            }
        }
        
        @media (max-width: 480px) {
            .PDPImageSwiper {
                height: 550px;
            }
            
            .ProductPage_container {
                margin: 0 8px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Telegram Header (статичный) -->
    <div class="telegram-header" style="background-color: rgb(255, 255, 255); --color-header-text: var(--color-text); position: fixed; top: 0; left: 0; right: 0; z-index: 1000;">
            <button type="button" class="Button smaller translucent round" aria-label="Back" title="Back" onclick="goBack()">
                <div class="RuJ3d9N6">
                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                    </svg>
                </div>
            </button>
            <div class="modal-title">WHATWILLWEWEAR</div>
            <div class="DropdownMenu web-app-more-menu with-menu-transitions">
                <button type="button" class="Button kKPD09tc smaller translucent round" aria-label="More actions" title="More actions" onclick="toggleTelegramMenu()">
                    <i class="icon icon-more" aria-hidden="true">
                        <svg width="20px" height="20px" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path>
                        </svg>
                    </i>
                </button>
                <div class="Menu web-app-more-menu with-menu-transitions">
                    <div role="presentation" class="bubble menu-container custom-scroll opacity-transition fast not-shown not-open">
                        <div role="menuitem" tabindex="0" class="MenuItem">
                            <i class="icon icon-bots" aria-hidden="true">
                                <svg width="16px" height="16px" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path>
                                </svg>
                            </i>
                            Open Bot
                        </div>
                        <div role="menuitem" tabindex="0" class="MenuItem">
                            <i class="icon icon-reload" aria-hidden="true">
                                <svg width="16px" height="16px" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path>
                                </svg>
                            </i>
                            Reload Page
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Основной контент страницы -->
    <div class="ProductPage">
            <div class="flex flex-col grow overflow-auto gap-5">
                
                <!-- Галерея изображений -->
                <div class="relative sectionContainer">
                    <div class="swiper swiper-initialized swiper-horizontal PDPImageSwiper relative">
                        <div class="swiper-wrapper">
                            {% if product.image %}
                            <div class="swiper-slide swiper-slide-active">
                                <img class="w-full h-full" loading="lazy" src="{{ product.image }}" alt="{{ product.name }}">
                            </div>
                            {% else %}
                            <div class="swiper-slide swiper-slide-active">
                                <div class="product-image-placeholder">📷</div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="swiper-pagination swiper-pagination-bullets swiper-pagination-horizontal">
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                        </div>
                        <button class="share" onclick="shareProduct()" style="position: absolute; top: 16px; right: 16px; z-index: 50; color: #ffffff; border: none; padding: 8px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;">
                            <svg width="20px" height="20px" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M13 4.4932C13 4.05265 13.5289 3.82775 13.8467 4.13285L20.624 10.6397C20.8287 10.8365 20.8289 11.1637 20.624 11.3604L13.8467 17.8672C13.529 18.1719 13.0004 17.947 13 17.5069V14C7.02671 13 4 18 4 18C4 12.4772 7.47715 8.00003 13 8.00003V4.4932Z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Атрибуты товара -->
                <div class="flex flex-col ProductPage_container gap-4 PDPAttributeContainer">
                    
                    <!-- Выбор цвета -->
                    <div class="flex flex-col gap-2">
                        <span class="attribute-label">Цвет: <span class="attribute-value" id="selected-color">Выберите цвет</span></span>
                        <div class="flex flex-row gap-2 flex-wrap attribute-options" id="color-options" style="padding: 8px 0;">

                            {% if product.available_colors %}
                                {% for color in product.available_colors %}
                                <button class="option-button color-option" data-color="{{ color }}" onclick="selectColor('{{ color }}')">
                                    {{ color }}
                                </button>
                                {% endfor %}
                            {% else %}
                                <span style="color: #666666; padding: 4px 8px; font-size: 14px;">Цвет не указан</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Выбор размера -->
                    <div class="flex flex-col gap-2">
                        <span class="attribute-label">Размер: <span class="attribute-value" id="selected-size">Выберите размер</span></span>
                        <div class="flex flex-row gap-2 flex-wrap attribute-options" id="size-options" style="padding: 8px 0;">

                            {% if product.available_sizes %}
                                {% for size in product.available_sizes %}
                                <button class="option-button size-option" data-size="{{ size }}" onclick="selectSize('{{ size }}')">
                                    {{ size }}
                                </button>
                                {% endfor %}
                            {% else %}
                                <span style="color: #666666; padding: 4px 8px; font-size: 14px;">Размер не указан</span>
                            {% endif %}
                        </div>
                    </div>

                </div>
                
                <!-- Разделитель после атрибутов -->
                <div style="height: 6px; background-color: #f0f0f0; margin: 12px 0;"></div>

                <!-- Описание товара -->
                <div class="flex flex-col gap-4 ProductPage_container Description">
                    <div class="flex flex-col gap-2">
                        <span class="product-title">{{ product.name }}</span>
                        <div class="flex flex-row gap-2 items-baseline">
                            <span class="product-price">{{ "%.0f"|format(product.price) }} ₽</span>
                        </div>
                        <!-- Отступ после цены -->
                        <div style="margin-bottom: 16px;"></div>
                    </div>
                    
                    <div class="flex flex-col gap-2">
                        <span class="description-title">Описание товара</span>
                        <div>
                            <div class="description-content">
                                <span style="color: #000000; font-size: 13px; margin-bottom: 0; display: block;">Арт. {{ product.article or 'Не указан' }}</span>
                                <div>
                                    <p style="color: #000000; font-size: 13px; margin-bottom: 0;">{{ product.description or 'Описание товара отсутствует' }}</p>
                                    {% if product.modifications %}
                                    <p><strong>Доступные варианты:</strong></p>
                                    <ul>
                                        {% for mod, stock in product.modifications.items() %}
                                        <li>{{ mod }} - {{ stock }} шт.</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-row gap-1 cursor-pointer read-more" onclick="toggleDescription()">
                            <span>Читать дальше</span>
                            <svg width="16px" height="16px" viewBox="0 0 16 16" fill="var(--text-secondary)" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2.29289 5.28989C2.68342 4.89937 3.31658 4.89937 3.70711 5.28989L8 9.58279L12.2929 5.28989C12.6834 5.68042 14.0976 6.31358 13.7071 6.70411L8.70711 11.7041C8.31658 12.0946 7.68342 12.0946 7.29289 11.7041L2.29289 6.70411C1.90237 6.31358 1.90237 5.68042 2.29289 5.28989Z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Разделитель перед поддержкой -->
                <div style="height: 6px; background-color: #f0f0f0; margin: 12px 0;"></div>

                <!-- Поддержка -->
                <div class="flex flex-col gap-4 ProductPage_container support-section">
                    <span class="support-title">Остались вопросы?</span>
                    <button class="support-button" onclick="openTelegramChat()">Написать Валентине</button>
                </div>

                <!-- Разделитель после поддержки -->
                <div style="height: 6px; background-color: #f0f0f0; margin: 12px 0;"></div>

            </div>

            <!-- Нижняя панель с кнопкой корзины -->
            <div class="bg-backgroundBottomBar">
                <div class="ProductPage_bottomButtonWrapper bottomButtonWrapper_tdesktop">
                    <div class="flex gap-4 h-full" id="cart-buttons-container" style="width: 100%;">
                        <button class="add-to-cart-button" id="add-to-cart-btn" onclick="showQuantitySelector()" disabled>
                            Добавить в корзину
                        </button>
                        <div class="cart-after-add" id="cart-after-add" style="display: none; width: 100%;">
                            <div style="display: flex; flex-direction: column; width: 100%; height: 100%; gap: 8px;">

                                <div style="display: flex; flex-direction: row; width: 100%; height: 100%;">
                                    <div class="quantity-counter" style="width: 30%; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 8px 0 0 8px; margin: 0; border: none;">
                                        <button class="quantity-btn minus-btn" onclick="decreaseQuantity()" style="background: none; border: none; font-size: 20px; font-weight: bold; color: #666; cursor: pointer; padding: 8px 12px; border-radius: 4px; transition: all 0.3s ease; opacity: 0.5;" disabled>-</button>
                                        <span id="selected-quantity" style="padding: 0 16px; font-size: 16px; font-weight: 600; color: #1a1a1a; min-width: 40px; text-align: center;">1</span>
                                        <button class="quantity-btn plus-btn" onclick="increaseQuantity()" style="background: none; border: none; font-size: 20px; font-weight: bold; color: #666; cursor: pointer; padding: 8px 12px; border-radius: 4px; transition: all 0.3s ease;">+</button>
                                    </div>
                                    <button class="go-to-cart-button" onclick="addToCart()" style="width: 70%; background: #333333; color: #ffffff; border: none; padding: 18px 24px; border-radius: 0 8px 8px 0; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin: 0; margin-left: 0;">
                                        Перейти в корзину
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a class="cart-icon" href="/cart" id="cart-icon">
                        <div class="cart-count" id="cart-count">0</div>
                        <svg width="24px" height="24px" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.00003 6.99994C7.00006 4.23854 9.23863 2 12 2C14.7615 2 17 4.23858 17 7L17.9182 7C18.4057 6.99999 18.8233 6.99998 19.1662 7.0244C19.5247 7.04993 19.8844 7.10612 20.2332 7.26246C21.0139 7.61241 21.608 8.27901 21.8662 9.09464C21.9815 9.45903 21.9961 9.82278 21.9804 10.1819C21.9654 10.5253 21.9175 10.9402 21.8616 11.4245L21.4083 15.3553C21.2163 17.0252 21.0884 18.1369 20.6207 19.038C19.9989 20.2358 18.9584 21.1631 17.6973 21.6436C16.7486 22.005 15.6295 22.0046 13.9486 22.0039H10.0493C8.36895 22.0046 7.25025 22.005 6.30176 21.6437C5.0409 21.1635 4.00054 20.2366 3.37857 19.0393C2.91069 18.1386 2.7825 17.0273 2.58995 15.3581L2.13496 11.4259C2.07889 10.9415 2.03086 10.5265 2.0157 10.183C1.99985 9.8238 2.01432 9.45994 2.1296 9.09543C2.38761 8.27954 2.98176 7.61267 3.76258 7.26257C4.11143 7.10616 4.47121 7.04995 4.82983 7.02441C5.17283 6.99998 5.5906 6.99999 6.07825 7L7.00003 6.99994ZM12 4C10.3432 4 9.00005 5.34312 9.00003 6.99996L15 7C15 5.34315 13.6569 4 12 4ZM16.8048 12.2499C16.942 11.7149 16.6196 11.17 16.0847 11.0327C15.5497 10.8955 15.0048 11.2178 14.8675 11.7528C14.535 13.0486 13.3645 14 11.9799 14C10.5953 14 9.42476 13.0486 9.09225 11.7528C8.95498 11.2178 8.41003 10.8955 7.87508 11.0327C7.34012 11.17 7.01774 11.7149 7.15501 12.2499C7.70754 14.4031 9.65453 16 11.9799 16C14.3052 16 16.2522 14.4031 16.8048 12.2499Z" fill="white"></path>
                        </svg>
                    </a>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
    <script>
        // Функции для Telegram Header
        function goBack() {
            window.history.back();
        }

        function toggleTelegramMenu() {
            const menu = document.querySelector('.telegram-header .Menu');
            if (menu) {
                menu.classList.toggle('not-shown');
                menu.classList.toggle('not-open');
            }
        }

        // Закрытие Telegram header при клике вне меню
        document.addEventListener('click', function(event) {
            const telegramHeader = document.querySelector('.telegram-header');
            const menu = document.querySelector('.telegram-header .Menu');
            if (telegramHeader && !telegramHeader.contains(event.target)) {
                if (menu) {
                    menu.classList.add('not-shown', 'not-open');
                }
            }
        });

        // Инициализация состояния меню при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            const menu = document.querySelector('.telegram-header .Menu');
            if (menu) {
                menu.classList.add('not-shown', 'not-open');
            }
        });

        // Инициализация Swiper
        const swiper = new Swiper('.PDPImageSwiper', {
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
        });

        // Состояние выбора
        let selectedColor = null;
        let selectedSize = null;
        let selectedQuantity = 1;
        
        // Данные о вариантах товара (получаем из Jinja2)
        const productVariants = {{ product.variants | tojson | safe }};
        
        // Функция для получения максимального доступного количества для выбранной комбинации
        function getMaxAvailableQuantity(color, size) {
            if (!productVariants) return 1;
            
            const hasColors = {% if product.available_colors %}true{% else %}false{% endif %};
            const hasSizes = {% if product.available_sizes %}true{% else %}false{% endif %};
            
            // Если у товара есть и цвет, и размер - ищем точную комбинацию
            if (hasColors && hasSizes) {
                for (const variant of productVariants) {
                    if (variant.colors.includes(color) && variant.sizes.includes(size)) {
                        return variant.stock || 1;
                    }
                }
            }
            
            // Если у товара есть только цвет - ищем по цвету
            if (hasColors && !hasSizes && color) {
                for (const variant of productVariants) {
                    if (variant.colors.includes(color)) {
                        return variant.stock || 1;
                    }
                }
            }
            
            // Если у товара есть только размер - ищем по размеру
            if (!hasColors && hasSizes && size) {
                for (const variant of productVariants) {
                    if (variant.sizes.includes(size)) {
                        return variant.stock || 1;
                    }
                }
            }
            
            // Если у товара нет ни цвета, ни размера - берем общий stock
            if (!hasColors && !hasSizes) {
                const totalStock = productVariants.reduce((sum, variant) => sum + (variant.stock || 0), 0);
                return totalStock || 1;
            }
            
            return 1;
        }
        
        // Функция для обновления доступности опций
        function updateOptionAvailability() {
            if (!productVariants) return;
            
            // Обновляем доступность цветов
            document.querySelectorAll('.color-option').forEach(colorBtn => {
                const color = colorBtn.dataset.color;
                let hasAvailableSize = false;
                
                // Проверяем, есть ли доступные размеры для этого цвета
                for (const variant of productVariants) {
                    if (variant.colors.includes(color) && variant.stock > 0) {
                        hasAvailableSize = true;
                        break;
                    }
                }
                
                if (hasAvailableSize) {
                    colorBtn.classList.remove('unavailable');
                    colorBtn.disabled = false;
                } else {
                    colorBtn.classList.add('unavailable');
                    colorBtn.disabled = true;
                }
            });
            
            // Обновляем доступность размеров
            document.querySelectorAll('.size-option').forEach(sizeBtn => {
                const size = sizeBtn.dataset.size;
                let hasAvailableColor = false;
                
                // Проверяем, есть ли доступные цвета для этого размера
                for (const variant of productVariants) {
                    if (variant.sizes.includes(size) && variant.stock > 0) {
                        hasAvailableColor = true;
                        break;
                    }
                }
                
                if (hasAvailableColor) {
                    sizeBtn.classList.remove('unavailable');
                    sizeBtn.disabled = false;
                } else {
                    sizeBtn.classList.add('unavailable');
                    sizeBtn.disabled = true;
                }
            });
        }
        
        // Функция для обновления доступности опций с учетом уже выбранных
        function updateOptionAvailabilityWithSelection() {
            if (!productVariants) return;
            
            // Обновляем доступность цветов с учетом выбранного размера
            document.querySelectorAll('.color-option').forEach(colorBtn => {
                const color = colorBtn.dataset.color;
                let isAvailable = false;
                
                if (selectedSize) {
                    // Если размер уже выбран, проверяем только комбинации с этим размером
                    for (const variant of productVariants) {
                        if (variant.colors.includes(color) && variant.sizes.includes(selectedSize) && variant.stock > 0) {
                            isAvailable = true;
                            break;
                        }
                    }
                } else {
                    // Если размер не выбран, проверяем общую доступность цвета
                    for (const variant of productVariants) {
                        if (variant.colors.includes(color) && variant.stock > 0) {
                            isAvailable = true;
                            break;
                        }
                    }
                }
                
                if (isAvailable) {
                    colorBtn.classList.remove('unavailable');
                    colorBtn.disabled = false;
                } else {
                    colorBtn.classList.add('unavailable');
                    colorBtn.disabled = true;
                }
            });
            
            // Обновляем доступность размеров с учетом выбранного цвета
            document.querySelectorAll('.size-option').forEach(sizeBtn => {
                const size = sizeBtn.dataset.size;
                let isAvailable = false;
                
                if (selectedColor) {
                    // Если цвет уже выбран, проверяем только комбинации с этим цветом
                    for (const variant of productVariants) {
                        if (variant.sizes.includes(size) && variant.colors.includes(selectedColor) && variant.stock > 0) {
                            isAvailable = true;
                            break;
                        }
                    }
                } else {
                    // Если цвет не выбран, проверяем общую доступность размера
                    for (const variant of productVariants) {
                        if (variant.sizes.includes(size) && variant.stock > 0) {
                            isAvailable = true;
                            break;
                        }
                    }
                }
                
                if (isAvailable) {
                    sizeBtn.classList.remove('unavailable');
                    sizeBtn.disabled = false;
                } else {
                    sizeBtn.classList.add('unavailable');
                    sizeBtn.disabled = true;
                }
            });
        }
        

        
        // Функция для обновления лимитов количества
        function updateQuantityLimits() {
            const minusBtn = document.querySelector('.minus-btn');
            const plusBtn = document.querySelector('.plus-btn');
            const quantitySpan = document.getElementById('selected-quantity');
            
            const hasColors = {% if product.available_colors %}true{% else %}false{% endif %};
            const hasSizes = {% if product.available_sizes %}true{% else %}false{% endif %};
            
            // Проверяем, выбраны ли необходимые атрибуты
            let canUpdateQuantity = true;
            
            if (hasColors && !selectedColor) {
                canUpdateQuantity = false;
            }
            
            if (hasSizes && !selectedSize) {
                canUpdateQuantity = false;
            }
            
            // Если атрибуты не выбраны, блокируем кнопки
            if (!canUpdateQuantity) {
                selectedQuantity = 1;
                quantitySpan.textContent = selectedQuantity;
                minusBtn.disabled = true;
                plusBtn.disabled = true;
                minusBtn.style.opacity = '0.5';
                plusBtn.style.opacity = '0.5';
                return;
            }
            
            // Получаем максимальное доступное количество
            const maxQuantity = getMaxAvailableQuantity(selectedColor, selectedSize);
            
            // Обновляем текущее количество, если оно превышает максимум
            if (selectedQuantity > maxQuantity) {
                selectedQuantity = maxQuantity;
                quantitySpan.textContent = selectedQuantity;
            }
            
            // Обновляем состояние кнопок
            minusBtn.disabled = selectedQuantity <= 1;
            plusBtn.disabled = selectedQuantity >= maxQuantity;
            
            // Обновляем прозрачность кнопок
            minusBtn.style.opacity = selectedQuantity <= 1 ? '0.5' : '1';
            plusBtn.style.opacity = selectedQuantity >= maxQuantity ? '0.5' : '1';
        }
        
        // Функции для изменения количества
        function increaseQuantity() {
            const hasColors = {% if product.available_colors %}true{% else %}false{% endif %};
            const hasSizes = {% if product.available_sizes %}true{% else %}false{% endif %};
            
            // Проверяем, выбраны ли необходимые атрибуты
            if (hasColors && !selectedColor) {
                return;
            }
            
            if (hasSizes && !selectedSize) {
                return;
            }
            
            // Получаем максимальное доступное количество
            const maxQuantity = getMaxAvailableQuantity(selectedColor, selectedSize);
            if (selectedQuantity < maxQuantity) {
                selectedQuantity++;
                document.getElementById('selected-quantity').textContent = selectedQuantity;
                updateQuantityLimits();
            }
        }
        
        function decreaseQuantity() {
            const hasColors = {% if product.available_colors %}true{% else %}false{% endif %};
            const hasSizes = {% if product.available_sizes %}true{% else %}false{% endif %};
            
            // Проверяем, выбраны ли необходимые атрибуты
            if (hasColors && !selectedColor) {
                return;
            }
            
            if (hasSizes && !selectedSize) {
                return;
            }
            
            if (selectedQuantity > 1) {
                selectedQuantity--;
                document.getElementById('selected-quantity').textContent = selectedQuantity;
                updateQuantityLimits();
            }
        }

        // Функция выбора цвета
        function selectColor(color) {
            selectedColor = color;
            
            // Обновляем UI
            document.getElementById('selected-color').textContent = color;
            
            // Обновляем кнопки
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.color === color) {
                    btn.classList.add('selected');
                }
            });
            
            // Обновляем доступность опций и лимиты количества
            updateOptionAvailabilityWithSelection();
            updateQuantityLimits();
            
            checkCanAddToCart();
        }

        // Функция выбора размера
        function selectSize(size) {
            selectedSize = size;
            
            // Обновляем UI
            document.getElementById('selected-size').textContent = size;
            
            // Обновляем кнопки
            document.querySelectorAll('.size-option').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.size === size) {
                    btn.classList.add('selected');
                }
            });
            
            // Обновляем доступность опций и лимиты количества
            updateOptionAvailabilityWithSelection();
            updateQuantityLimits();
            
            checkCanAddToCart();
        }

        // Проверка возможности добавления в корзину
        function checkCanAddToCart() {
            const addButton = document.getElementById('add-to-cart-btn');
            const hasColors = {% if product.available_colors %}true{% else %}false{% endif %};
            const hasSizes = {% if product.available_sizes %}true{% else %}false{% endif %};
            
            let canAdd = true;
            let message = 'Добавить в корзину';
            
            if (hasColors && !selectedColor) {
                canAdd = false;
                message = 'Выберите цвет';
            }
            
            if (hasSizes && !selectedSize) {
                canAdd = false;
                if (hasColors && !selectedColor) {
                    message = 'Выберите цвет и размер';
                } else {
                    message = 'Выберите размер';
                }
            }
            
            // Если нет ни цвета, ни размера, то товар можно добавить без выбора
            if (!hasColors && !hasSizes) {
                canAdd = true;
                message = 'Добавить в корзину';
            }
            
            addButton.disabled = !canAdd;
            addButton.textContent = message;
        }

        // Показать селектор количества (не добавляет в корзину)
        function showQuantitySelector() {
            const hasColors = {% if product.available_colors %}true{% else %}false{% endif %};
            const hasSizes = {% if product.available_sizes %}true{% else %}false{% endif %};
            
            // Проверяем, выбраны ли необходимые атрибуты
            if (hasColors && !selectedColor) {
                alert('Пожалуйста, выберите цвет');
                return;
            }
            
            if (hasSizes && !selectedSize) {
                alert('Пожалуйста, выберите размер');
                return;
            }

            // Переключаем кнопки - показываем селектор количества
            document.getElementById('add-to-cart-btn').style.display = 'none';
            document.getElementById('cart-after-add').style.display = 'block';
            
            // Сбрасываем количество к 1 при показе селектора
            selectedQuantity = 1;
            document.getElementById('selected-quantity').textContent = selectedQuantity;
            
            // Обновляем лимиты количества
            updateQuantityLimits();
        }

        // Добавление в корзину (вызывается только при нажатии "Перейти в корзину")
        async function addToCart() {
            const hasColors = {% if product.available_colors %}true{% else %}false{% endif %};
            const hasSizes = {% if product.available_sizes %}true{% else %}false{% endif %};
            
            if (hasColors && !selectedColor) {
                alert('Пожалуйста, выберите цвет');
                return;
            }
            
            if (hasSizes && !selectedSize) {
                alert('Пожалуйста, выберите размер');
                return;
            }

            try {
                const response = await fetch('/api/add-to-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: window.currentUserId || 'demo_user',
                        product_id: '{{ product.original_id }}',
                        color: selectedColor,
                        size: selectedSize,
                        quantity: selectedQuantity || 1
                    })
                });

                                            if (response.ok) {
                                const result = await response.json();
                                if (result.success) {
                                    // Обновляем счетчик корзины с сервера
                                    await updateCartCountFromServer();

                                    // Переходим в корзину
                                    window.location.href = '/cart';
                                } else {
                                    showMessage(result.message || 'Ошибка добавления в корзину', 'error');
                                }
                            } else {
                                showMessage('Ошибка добавления в корзину', 'error');
                            }
            } catch (error) {
                console.error('Ошибка:', error);
                showMessage('Ошибка добавления в корзину', 'error');
            }
        }

        // Обновление счетчика корзины
        function updateCartCount(count) {
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = count;
            }
        }

        // Показать сообщение
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            const addButton = document.getElementById('add-to-cart-btn');
            addButton.parentNode.insertBefore(messageDiv, addButton.nextSibling);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Функции для кнопок
        function shareProduct() {
            if (navigator.share) {
                navigator.share({
                    title: '{{ product.name }}',
                    text: 'Посмотрите этот товар!',
                    url: window.location.href
                });
            } else {
                // Fallback для браузеров без поддержки Web Share API
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Ссылка скопирована в буфер обмена!');
                });
            }
        }

        function goToCart() {
            window.location.href = '/cart';
        }
        
        function contactSupport() {
            // Здесь можно добавить логику для связи с поддержкой
            alert('Функция связи с поддержкой будет добавлена позже');
        }

        function openTelegramChat() {
            // Открываем чат с @valentinav4 в Telegram
            const telegramUrl = 'https://t.me/valentinav4';
            
            // Если пользователь в Telegram WebApp, используем tg.openTelegramLink
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.openTelegramLink(telegramUrl);
            } else {
                // Fallback для обычного браузера - открываем в новой вкладке
                window.open(telegramUrl, '_blank');
            }
        }

        function toggleDescription() {
            const content = document.querySelector('.description-content');
            const button = document.querySelector('.read-more span');
            const icon = document.querySelector('.read-more svg');
            
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                button.textContent = 'Читать дальше';
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                button.textContent = 'Свернуть';
                icon.style.transform = 'rotate(180deg)';
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                
                // Получаем ID пользователя из Telegram
                window.currentUserId = tg.initDataUnsafe?.user?.id || 'demo_user';
            }
            
            // Загружаем количество товаров в корзине
            updateCartCountFromServer();
            
            // Обновляем доступность опций
            updateOptionAvailabilityWithSelection();
            
            // Проверяем возможность добавления в корзину
            checkCanAddToCart();
        });

        // Загрузка количества товаров в корзине с сервера
        async function updateCartCountFromServer() {
            try {
                const userId = window.currentUserId || 'demo_user';
                const response = await fetch(`/api/cart/${userId}`);
                if (response.ok) {
                    const cart = await response.json();
                    const count = cart.cart_items ? cart.cart_items.reduce((total, item) => total + item.quantity, 0) : 0;
                    updateCartCount(count);
                }
            } catch (error) {
                console.error('Ошибка загрузки корзины:', error);
                // Если сервер недоступен, показываем 0
                updateCartCount(0);
            }
        }
    </script>
</body>
</html>
