<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –ú–∞–≥–∞–∑–∏–Ω - –ö–∞—Ç–∞–ª–æ–≥</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <header class="catalog-header">
            <div class="header-content">
                <div class="logo-section">
                    <img src="/static/images/logo.svg" alt="W4STORE" class="logo">
                    <span class="brand-name">W4STORE</span>
                </div>
                <div class="header-actions">
                    <div class="cart-icon" onclick="openCart()">
                        üõí <span class="cart-count" id="cart-count">0</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã –≤ —Å—Ç–∏–ª–µ FASHION FABRIQUE -->
        <div class="search-section">
            <div class="search-container">
                            <div class="search-input-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." oninput="filterProducts()" onkeydown="if(event.key==='Enter') filterProducts()">
                <button type="button" id="clear-search" onclick="clearSearch()" style="display: none;">‚úï</button>
            </div>
            </div>
            <div class="category-dropdown">
                <button class="category-dropdown-btn" onclick="toggleCategoryDropdown()">
                    <span class="hamburger-icon">‚ò∞</span>
                    <span class="dropdown-text">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                </button>
                <div class="category-dropdown-content" id="categoryDropdown">
                    <div class="category-item active" onclick="filterByCategory('all')">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</div>
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Å—Ç–∏–ª–µ FASHION FABRIQUE -->
        <div class="products-container">
            <h2 class="section-title">–í—Å–µ —Ç–æ–≤–∞—Ä—ã ({{ products|selectattr('stock', 'gt', 0)|list|length }})</h2>
            <div class="products-grid" id="products-grid">
                {% for product in products %}
                    {% if product.stock > 0 %}
                <div class="product-card" data-category="{{ product.category }}" data-product-id="{{ product.id }}">
                    <!-- –ö–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–æ–≤–∞—Ä–∞ -->
                                            <div class="product-image-container" onclick="viewProduct('{{ product.original_id }}')">
                            {% if product.image %}
                            <img src="{{ product.image }}" alt="{{ product.name }}" class="product-image" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="product-image-placeholder" style="display: none;">
                                <span class="image-placeholder-text">üì∑</span>
                            </div>
                            {% else %}
                            <div class="product-image-placeholder">
                                <span class="image-placeholder-text">üì∑</span>
                            </div>
                            {% endif %}
                        </div>
                    
                    <!-- –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
                    <div class="product-info-simple">
                        <div class="product-price">‚ÇΩ{{ product.price }}</div>
                        <div class="product-name">{{ product.name }}</div>
                        <div class="product-color">{{ product.description|default('–¶–≤–µ—Ç –Ω–µ —É–∫–∞–∑–∞–Ω') }}</div>
                    </div>
                </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- –ü—É—Å—Ç–æ–π –∫–∞—Ç–∞–ª–æ–≥ -->
        <div class="empty-catalog" id="empty-catalog" style="display: none;">
            <div class="empty-icon">üì≠</div>
            <h3>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã</p>
        </div>

        <!-- –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã -->
        <div class="floating-cart" onclick="openCart()">
            üõí <span id="floating-cart-count">0</span>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ—Ä–∑–∏–Ω—ã -->
    <div class="modal" id="cart-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
                <button class="close-btn" onclick="closeCart()">&times;</button>
            </div>
            <div class="modal-body" id="cart-content">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
            window.currentUserId = tg.initDataUnsafe?.user?.id || 'demo_user';
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            tg.MainButton.text = '–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É';
            tg.MainButton.onClick(() => openCart());
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        let currentOffset = 0; // –ù–∞—á–∏–Ω–∞–µ–º —Å 0, —Ç–∞–∫ –∫–∞–∫ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Å—Ä–∞–∑—É
        let isLoading = false;
        let hasMore = false; // –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
        let currentCategory = 'all'; // –¢–µ–∫—É—â–∞—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            updateCartCount();
            setupInfiniteScroll();
            loadCategories(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            loadAllProducts(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Å—Ä–∞–∑—É
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        function toggleCategoryDropdown() {
            const dropdown = document.getElementById('categoryDropdown');
            dropdown.classList.toggle('show');
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('categoryDropdown');
            const dropdownBtn = document.querySelector('.category-dropdown-btn');
            
            if (!dropdown.contains(event.target) && !dropdownBtn.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ API
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories-with-products');
                const data = await response.json();
                
                const dropdown = document.getElementById('categoryDropdown');
                const categories = data.categories || [];
                
                // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∫—Ä–æ–º–µ "–í—Å–µ —Ç–æ–≤–∞—Ä—ã")
                const allItems = dropdown.querySelectorAll('.category-item:not(:first-child)');
                allItems.forEach(item => item.remove());
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ API —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–æ–≤–∞—Ä–æ–≤
                categories.forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-item';
                    categoryItem.textContent = `${category.name} (${category.product_count})`;
                    categoryItem.onclick = () => filterByCategory(category.name);
                    dropdown.appendChild(categoryItem);
                });
                
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${categories.length} –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å —Ç–æ–≤–∞—Ä–∞–º–∏`);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        function filterByCategory(category) {
            console.log('–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', category);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
            document.getElementById('categoryDropdown').classList.remove('show');
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
            event.target.classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            const dropdownText = document.querySelector('.dropdown-text');
            if (category === 'all') {
                dropdownText.textContent = '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏';
                currentCategory = 'all';
            } else {
                dropdownText.textContent = category;
                currentCategory = category;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            currentOffset = 0;
            hasMore = true;
            
            // –û—á–∏—â–∞–µ–º —Å–µ—Ç–∫—É —Ç–æ–≤–∞—Ä–æ–≤
            const productsGrid = document.getElementById('products-grid');
            productsGrid.innerHTML = '';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            loadMoreProducts();
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞)
        function setupInfiniteScroll() {
            // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ
            /*
            window.addEventListener('scroll', () => {
                if (isLoading || !hasMore) return;
                
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const windowHeight = window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–æ–≤ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –∫ –∫–æ–Ω—Ü—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                if (scrollTop + windowHeight >= documentHeight - 500) {
                    loadMoreProducts();
                }
            });
            */
        }
        
                        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ —Å—Ä–∞–∑—É
        async function loadAllProducts() {
            if (isLoading) return;
            
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã...');
            isLoading = true;
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Å—Ä–∞–∑—É
                const response = await fetch('/api/products?limit=1000&offset=0');
                const data = await response.json();
                
                if (data.products && data.products.length > 0) {
                    // –û—á–∏—â–∞–µ–º —Å–µ—Ç–∫—É —Ç–æ–≤–∞—Ä–æ–≤
                    const productsGrid = document.getElementById('products-grid');
                    productsGrid.innerHTML = '';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ —Å–µ—Ç–∫—É
                    data.products.forEach(product => {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏
                        if (product.stock > 0) {
                            const productCard = createProductCard(product);
                            productsGrid.appendChild(productCard);
                        }
                    });
                    
                    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.products.length} —Ç–æ–≤–∞—Ä–æ–≤`);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤
                    const title = document.querySelector('.section-title');
                    if (title) {
                        const currentCount = document.querySelectorAll('.product-card').length;
                        title.textContent = `–í—Å–µ —Ç–æ–≤–∞—Ä—ã (${currentCount})`;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
            } finally {
                isLoading = false;
            }
        }

                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º)
        async function loadMoreProducts() {
            if (isLoading || !hasMore) return;
            
            console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã: offset=${currentOffset}, category=${currentCategory}, isLoading=${isLoading}, hasMore=${hasMore}`);
            isLoading = true;
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const response = await fetch('/api/products?limit=1000&offset=0');
                const data = await response.json();
                
                if (data.products && data.products.length > 0) {
                    // –û—á–∏—â–∞–µ–º —Å–µ—Ç–∫—É —Ç–æ–≤–∞—Ä–æ–≤
                    const productsGrid = document.getElementById('products-grid');
                    productsGrid.innerHTML = '';
                    
                    let filteredCount = 0;
                    
                    data.products.forEach(product => {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏
                        if (product.stock > 0) {
                            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞
                            if (currentCategory === 'all' || 
                                product.category === currentCategory) {
                                const productCard = createProductCard(product);
                                productsGrid.appendChild(productCard);
                                filteredCount++;
                            }
                        }
                    });
                    
                    console.log(`‚úÖ –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${filteredCount} —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${currentCategory}"`);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤
                    const title = document.querySelector('.section-title');
                    if (title) {
                        const categoryText = currentCategory === 'all' ? '–í—Å–µ —Ç–æ–≤–∞—Ä—ã' : `–¢–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${currentCategory}"`;
                        title.textContent = `${categoryText} (${filteredCount})`;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
            } finally {
                isLoading = false;
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.setAttribute('data-category', product.category || '');
            card.setAttribute('data-product-id', product.id || '');
            
            const imageHtml = product.image 
                ? `<img src="${product.image}" alt="${product.name}" class="product-image" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                : '';
            
            const placeholderHtml = `<div class="product-image-placeholder" style="display: ${product.image ? 'none' : 'flex'};">üì∑</div>`;
            
            card.innerHTML = `
                <div class="product-image-container" onclick="viewProduct('${product.original_id || product.id}')">
                    ${imageHtml}
                    ${placeholderHtml}
                </div>
                <div class="product-info-simple">
                    <div class="product-price">‚ÇΩ${product.price}</div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-color">${product.description || '–¶–≤–µ—Ç –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                    <div class="product-article">–ê—Ä—Ç: ${product.article || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                </div>
            `;
            
            return card;
        }
    </script>
</body>
</html>
