<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—Ä–∑–∏–Ω–∞ - {{ shop_name }}</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="cart-page">
        <!-- Telegram Header (—Å—Ç–∞—Ç–∏—á–Ω—ã–π) -->
        <div class="telegram-header" style="background-color: rgb(255, 255, 255); --color-header-text: var(--color-text);">
            <button type="button" class="Button smaller translucent round" aria-label="Back" title="Back" onclick="goBack()">
                <div class="RuJ3d9N6">
                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                    </svg>
                </div>
            </button>
            <div class="modal-title">WHATWILLWEWEAR</div>
            <div class="DropdownMenu web-app-more-menu with-menu-transitions">
                <button type="button" class="Button kKPD09tc smaller translucent round" aria-label="More actions" title="More actions" onclick="toggleTelegramMenu()">
                    <i class="icon icon-more" aria-hidden="true">
                        <svg width="20px" height="20px" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path>
                        </svg>
                    </i>
                </button>
                <div class="Menu web-app-more-menu with-menu-transitions">
                    <div role="presentation" class="bubble menu-container custom-scroll opacity-transition fast not-shown not-open">
                        <div role="menuitem" tabindex="0" class="MenuItem">
                            <i class="icon icon-bots" aria-hidden="true">
                                <svg width="16px" height="16px" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path>
                                </svg>
                            </i>
                            Open Bot
                        </div>
                        <div role="menuitem" tabindex="0" class="MenuItem">
                            <i class="icon icon-reload" aria-hidden="true">
                                <svg width="16px" height="16px" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path>
                                </svg>
                            </i>
                            Reload Page
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã -->
        <div class="cart-content">
            <div class="page-heading">
                <span class="page-title">–ö–æ—Ä–∑–∏–Ω–∞</span>
                {% if cart_items %}
                <button class="cart-clear-text" onclick="clearCart()">
                    –û—á–∏—Å—Ç–∏—Ç—å
                </button>
                {% endif %}
            </div>
            {% if cart_items %}
                <!-- –¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
                <div class="cart-items">
                    {% for item in cart_items %}
                    <div class="cart-item" data-product-id="{{ item.product_id }}">
                        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (30%) -->
                        <div class="cart-item-image">
                            {% if item.image %}
                            <img src="{{ item.image }}" alt="{{ item.name }}" class="cart-item-image-real" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="cart-item-image-placeholder" style="display: none;">üì∑</div>
                            {% else %}
                            <div class="cart-item-image-placeholder">üì∑</div>
                            {% endif %}
                        </div>
                        
                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ (70%) -->
                        <div class="cart-item-info">
                            <h3 class="cart-item-name">{{ item.name.split(' (')[0] if ' (' in item.name else item.name }}</h3>
                            {% if ' (' in item.name %}<div class="cart-item-modifications">{% set mods = item.name.split(' (')[1].rstrip(')') %}{% if '—Ü–≤–µ—Ç' in mods and '—Ä–∞–∑–º–µ—Ä' in mods %}–¶–≤–µ—Ç: {{ mods.split('—Ü–≤–µ—Ç ')[1].split(',')[0] | title }} ‚Ä¢ –†–∞–∑–º–µ—Ä: {{ mods.split('—Ä–∞–∑–º–µ—Ä ')[1] | title }}{% elif '—Ü–≤–µ—Ç' in mods %}–¶–≤–µ—Ç: {{ mods.split('—Ü–≤–µ—Ç ')[1] | title }}{% elif '—Ä–∞–∑–º–µ—Ä' in mods %}–†–∞–∑–º–µ—Ä: {{ mods.split('—Ä–∞–∑–º–µ—Ä ')[1] | title }}{% else %}{{ mods | title }}{% endif %}</div>{% endif %}
                            <div class="cart-item-details">
                                <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ -->
                                <div class="cart-quantity-selector">
                                    <button class="quantity-btn minus-btn" onclick="decreaseCartQuantity('{{ item.product_id }}', {{ item.quantity }})" {% if item.quantity <= 1 %}style="opacity: 0.5;"{% endif %}>
                                        -
                                    </button>
                                    <span class="selected-quantity">{{ item.quantity }}</span>
                                    <button class="quantity-btn plus-btn" onclick="increaseCartQuantity('{{ item.product_id }}', {{ item.quantity }})">
                                        +
                                    </button>
                                </div>
                                <!-- –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ -->
                                <div class="cart-item-total">
                                    {{ "{:,.0f}".format(item.price * item.quantity) }} {{ currency }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
                <div class="cart-divider"></div>

                <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ -->
                <div class="cart-summary">
                    <!-- –ü–æ–ª–µ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
                    <div class="promo-code-section">
                        <div class="promo-input-container">
                            <input type="text" id="promo-input" class="promo-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" maxlength="20">
                            <button id="apply-promo-btn" class="apply-promo-btn" style="display: none;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                        <div id="promo-message" class="promo-message"></div>
                    </div>
                    
                    <div class="summary-row">
                        <span>–¢–æ–≤–∞—Ä—ã ({{ cart_items|length }} —à—Ç.)</span>
                        <span>{{ "{:,.0f}".format(total) }} {{ currency }}</span>
                    </div>
                    
                    <!-- –°—Ç—Ä–æ–∫–∞ —Å–∫–∏–¥–∫–∏ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div id="discount-row" class="summary-row discount" style="display: none;">
                        <span>–°–∫–∏–¥–∫–∞ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</span>
                        <span id="discount-amount">-0 {{ currency }}</span>
                    </div>
                    
                    <div class="summary-row total">
                        <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</span>
                        <span id="cart-total">{{ "{:,.0f}".format(total) }} {{ currency }}</span>
                    </div>
                </div>

            {% else %}
                <!-- –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
                <div class="empty-cart">
                    <div class="empty-cart-icon">üõí</div>
                    <h2>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
                    <p>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</p>
                    <button class="continue-shopping-btn" onclick="goToCatalog()">
                        üõçÔ∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–∞–º
                    </button>
                </div>
            {% endif %}
        </div>



        <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã) -->
        {% if cart_items %}
        <div class="cart-bottom-actions">
            <button class="cart-action-btn checkout-btn" onclick="checkout()">
                üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
            </button>

        </div>
        {% endif %}
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è Telegram Header
        function closeBot() {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.close();
            } else {
                // Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
                window.history.back();
            }
        }

        function toggleTelegramMenu() {
            const menu = document.querySelector('.telegram-header .Menu');
            if (menu) {
                menu.classList.toggle('not-shown');
                menu.classList.toggle('not-open');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ Telegram header –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
        document.addEventListener('click', function(event) {
            const telegramHeader = document.querySelector('.telegram-header');
            const menu = document.querySelector('.telegram-header .Menu');
            if (telegramHeader && !telegramHeader.contains(event.target)) {
                if (menu) {
                    menu.classList.add('not-shown', 'not-open');
                }
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–Ω—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            const menu = document.querySelector('.telegram-header .Menu');
            if (menu) {
                menu.classList.add('not-shown', 'not-open');
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
            initPromoCode();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            window.currentUserId = tg.initDataUnsafe?.user?.id || 'demo_user';
            
            {% if cart_items %}
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
            tg.MainButton.text = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ({{ "{:,.0f}".format(total) }} {{ currency }})';
            tg.MainButton.show();
            tg.MainButton.onClick(() => checkout());
            {% endif %}
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        async function updateQuantityButtonsState() {
            const quantitySelectors = document.querySelectorAll('.cart-quantity-selector');
            
            for (const selector of quantitySelectors) {
                const productId = selector.closest('.cart-item').dataset.productId;
                const quantitySpan = selector.querySelector('.selected-quantity');
                const plusBtn = selector.querySelector('.plus-btn');
                const minusBtn = selector.querySelector('.minus-btn');
                
                if (!productId || !quantitySpan || !plusBtn || !minusBtn) continue;
                
                const currentQuantity = parseInt(quantitySpan.textContent);
                
                try {
                    const response = await fetch(`/api/product/${productId}`);
                    const data = await response.json();
                    const product = data.product;
                    const maxStock = product.stock || 0;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                    if (currentQuantity >= maxStock) {
                        plusBtn.disabled = true;
                        plusBtn.classList.add('max-reached');
                        plusBtn.title = `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${maxStock} —à—Ç.`;
                        plusBtn.style.opacity = '0.5';
                    } else {
                        plusBtn.disabled = false;
                        plusBtn.classList.remove('max-reached');
                        plusBtn.title = '';
                        plusBtn.style.opacity = '1';
                    }
                    
                    if (currentQuantity <= 1) {
                        minusBtn.disabled = false;
                        minusBtn.style.opacity = '0.5';
                        minusBtn.title = '–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä';
                    } else {
                        minusBtn.disabled = false;
                        minusBtn.style.opacity = '1';
                        minusBtn.title = '–£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ';
                    }
                    
                } catch (error) {
                    console.error('Error updating quantity buttons state:', error);
                }
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            if (document.querySelector('.cart-quantity-selector')) {
                updateQuantityButtonsState();
            }
        });



        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤ –∫–æ—Ä–∑–∏–Ω–µ
        function increaseCartQuantity(productId, currentQuantity) {
            console.log('Increasing quantity for product:', productId, 'from', currentQuantity);
            
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ –∏ –µ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞—Ö
            fetch(`/api/product/${productId}`)
            .then(response => response.json())
            .then(data => {
                const product = data.product;
                const maxStock = product.stock || 0;
                
                console.log('Product info:', product);
                console.log('Current quantity:', currentQuantity, 'Max stock:', maxStock);
                
                if (currentQuantity >= maxStock) {
                    alert(`–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${maxStock} —à—Ç.`);
                    return;
                }
                
                // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã, –æ–±–Ω–æ–≤–ª—è–µ–º
                updateCartQuantity(productId, currentQuantity + 1);
            })
            .catch(error => {
                console.error('Error getting product info:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            });
        }

        function clearCart() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) {
                console.log('Clearing cart');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—á–∏—Å—Ç–∫—É –∫–æ—Ä–∑–∏–Ω—ã
                fetch('/api/clear-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: 'demo_user'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã');
                });
            }
        }

        function checkout() {
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
            alert('–§—É–Ω–∫—Ü–∏—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ');
        }

        function goToCatalog() {
            window.location.href = '/';
        }

        function goBack() {
            goToCatalog();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
        function decreaseCartQuantity(productId, currentQuantity) {
            console.log('üîç decreaseCartQuantity –≤—ã–∑–≤–∞–Ω–∞');
            console.log('  ‚Ä¢ productId:', productId);
            console.log('  ‚Ä¢ currentQuantity:', currentQuantity);
            
            if (currentQuantity <= 1) {
                // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ 1, —Ç–æ —É–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
                console.log('üóëÔ∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ <= 1, —É–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä');
                removeFromCartServer(productId);
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞:', currentQuantity - 1);
            updateCartQuantity(productId, currentQuantity - 1);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
        function increaseCartQuantity(productId, currentQuantity) {
            console.log('üîç increaseCartQuantity –≤—ã–∑–≤–∞–Ω–∞');
            console.log('  ‚Ä¢ productId:', productId);
            console.log('  ‚Ä¢ currentQuantity:', currentQuantity);
            
            // –ü—Ä–æ—Å—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ - —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç –æ—Å—Ç–∞—Ç–∫–∏
            console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞:', currentQuantity + 1);
            updateCartQuantity(productId, currentQuantity + 1);
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
        function updateCartQuantity(productId, newQuantity) {
            console.log('üîç updateCartQuantity –≤—ã–∑–≤–∞–Ω–∞');
            console.log('  ‚Ä¢ productId:', productId);
            console.log('  ‚Ä¢ newQuantity:', newQuantity);
            
            fetch('/api/update-cart-quantity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: 'demo_user',
                    product_id: productId,
                    quantity: newQuantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É');
                    location.reload();
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞:', data.message);
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: ' + data.message);
                }
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: ' + error.message);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
        function removeFromCartServer(productId) {
            console.log('üîç removeFromCartServer –≤—ã–∑–≤–∞–Ω–∞');
            console.log('  ‚Ä¢ productId:', productId);
            console.log('  ‚Ä¢ –¢–∏–ø productId:', typeof productId);
            
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) {
                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —É–¥–∞–ª–µ–Ω–∏–µ');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
                console.log('üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/remove-from-cart');
                console.log('üì° –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', {
                    user_id: 'demo_user',
                    product_id: productId
                });
                
                fetch('/api/remove-from-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: 'demo_user',
                        product_id: productId
                    })
                })
                .then(response => {
                    console.log('üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
                    console.log('üîç –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
                    console.log('üîç –ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', response.headers);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('üîç –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
                    if (data.success) {
                        console.log('‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É');
                        location.reload();
                    } else {
                        console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', data.message);
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞:', error);
                    console.error('‚ùå –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error.message);
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: ' + error.message);
                });
            } else {
                console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª —É–¥–∞–ª–µ–Ω–∏–µ');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
        function openMenu() {
            const menuModal = document.getElementById('menu-modal');
            menuModal.style.display = 'block';
            setTimeout(() => {
                menuModal.classList.add('show');
            }, 10);
        }

        function closeMenu() {
            const menuModal = document.getElementById('menu-modal');
            menuModal.classList.remove('show');
            setTimeout(() => {
                menuModal.style.display = 'none';
            }, 300);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
        function showDeliveryInfo() {
            alert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ');
        }

        function showPaymentInfo() {
            alert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ');
        }

        function showContacts() {
            alert('–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ');
        }

        function showSupport() {
            alert('–§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ');
        }

        function showPrivacyPolicy() {
            alert('–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ');
        }

        // –õ–æ–≥–∏–∫–∞ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
        function initPromoCode() {
            const promoInput = document.getElementById('promo-input');
            const applyBtn = document.getElementById('apply-promo-btn');
            const promoMessage = document.getElementById('promo-message');
            
            if (!promoInput || !applyBtn || !promoMessage) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –≤–≤–æ–¥–µ –ª—é–±–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
            promoInput.addEventListener('input', function() {
                if (this.value.trim().length > 0) {
                    applyBtn.style.display = 'block';
                } else {
                    applyBtn.style.display = 'none';
                    promoMessage.textContent = '';
                    promoMessage.className = 'promo-message';
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
            applyBtn.addEventListener('click', function() {
                applyPromoCode(promoInput.value.trim());
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            promoInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.value.trim().length > 0) {
                    applyPromoCode(this.value.trim());
                }
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
        function applyPromoCode(code) {
            const promoMessage = document.getElementById('promo-message');
            const discountRow = document.getElementById('discount-row');
            const discountAmount = document.getElementById('discount-amount');
            const cartTotal = document.getElementById('cart-total');
            
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã
            const promoCodes = {
                'SALE20': { type: 'percent', value: 20, description: '–°–∫–∏–¥–∫–∞ 20%' },
                'SAVE500': { type: 'fixed', value: 500, description: '–°–∫–∏–¥–∫–∞ 500 ‚ÇΩ' },
                'WELCOME': { type: 'percent', value: 15, description: '–°–∫–∏–¥–∫–∞ 15%' }
            };
            
            const promoCode = promoCodes[code.toUpperCase()];
            
            if (promoCode) {
                // –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞–π–¥–µ–Ω
                const originalTotal = {{ total }};
                let discountValue = 0;
                
                if (promoCode.type === 'percent') {
                    discountValue = Math.round(originalTotal * promoCode.value / 100);
                } else {
                    discountValue = Math.min(promoCode.value, originalTotal);
                }
                
                const finalTotal = originalTotal - discountValue;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–∏–¥–∫—É
                discountRow.style.display = 'flex';
                discountAmount.textContent = `-${discountValue.toLocaleString()} {{ currency }}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
                cartTotal.textContent = `${finalTotal.toLocaleString()} {{ currency }}`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                promoMessage.textContent = `‚úÖ ${promoCode.description} –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!`;
                promoMessage.className = 'promo-message success';
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫—É
                document.getElementById('promo-input').disabled = true;
                document.getElementById('apply-promo-btn').disabled = true;
                
            } else {
                // –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω
                promoMessage.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥';
                promoMessage.className = 'promo-message error';
            }
        }


    </script>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –º–µ–Ω—é -->
    <div class="menu-modal" id="menu-modal">
        <div class="menu-overlay" onclick="closeMenu()"></div>
        <div class="menu-content">
            <div class="menu-header">
                <h2>–ú–µ–Ω—é</h2>
                <button class="close-btn" onclick="closeMenu()">&times;</button>
            </div>
            <div class="menu-body">
                <div class="menu-item" onclick="showDeliveryInfo()">
                    <span class="menu-icon">üöö</span>
                    <span class="menu-text">–î–æ—Å—Ç–∞–≤–∫–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç</span>
                </div>
                <div class="menu-item" onclick="showPaymentInfo()">
                    <span class="menu-icon">üí≥</span>
                    <span class="menu-text">–û–ø–ª–∞—Ç–∞</span>
                </div>
                <div class="menu-item" onclick="showContacts()">
                    <span class="menu-icon">üìû</span>
                    <span class="menu-text">–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
                </div>
                <div class="menu-item" onclick="showSupport()">
                    <span class="menu-icon">üí¨</span>
                    <span class="menu-text">–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º</span>
                </div>
                <div class="menu-item" onclick="showPrivacyPolicy()">
                    <span class="menu-icon">üìÑ</span>
                    <span class="menu-text">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</span>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
