<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—Ä–∑–∏–Ω–∞ - {{ shop_name }}</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="cart-page">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ—Ä–∑–∏–Ω—ã -->
        <header class="cart-header">
            <div class="header-content">
                <button class="back-button" onclick="goBack()">‚Üê</button>
                <div class="logo-section">
                    <img src="/static/images/logo.svg" alt="W4STORE" class="logo-small">
                </div>
                <h1 class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</h1>
            </div>
        </header>

        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã -->
        <div class="cart-content">
            {% if cart_items %}
                <!-- –¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
                <div class="cart-items">
                    {% for item in cart_items %}
                    <div class="cart-item" data-product-id="{{ item.product_id }}">
                                                    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
                            <div class="cart-item-image">
                                {% if item.image %}
                                <img src="{{ item.image }}" alt="{{ item.name }}" class="cart-item-image-real" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="cart-item-image-placeholder" style="display: none;">üì∑</div>
                                {% else %}
                                <div class="cart-item-image-placeholder">üì∑</div>
                                {% endif %}
                            </div>
                        
                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
                        <div class="cart-item-info">
                            <h3 class="cart-item-name">{{ item.name }}</h3>
                            <div class="cart-item-details">
                                <div class="cart-item-price">{{ "{:,.0f}".format(item.price) }} {{ currency }}</div>
                                <div class="cart-item-quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {{ item.quantity }}</div>
                            </div>
                        </div>
                        
                        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏–µ–º -->
                        <div class="cart-item-controls">
                            <!-- –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ -->
                            <div class="cart-item-total">
                                {{ "{:,.0f}".format(item.price * item.quantity) }} {{ currency }}
                            </div>
                            
                            <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                            <button class="remove-btn" onclick="removeFromCart('{{ item.product_id }}')" title="–£–¥–∞–ª–∏—Ç—å">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ -->
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>–¢–æ–≤–∞—Ä—ã ({{ cart_items|length }} —à—Ç.)</span>
                        <span>{{ "{:,.0f}".format(total) }} {{ currency }}</span>
                    </div>
                    <div class="summary-row">
                        <span>–î–æ—Å—Ç–∞–≤–∫–∞</span>
                        <span>–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                    </div>
                    <div class="summary-row total">
                        <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</span>
                        <span id="cart-total">{{ "{:,.0f}".format(total) }} {{ currency }}</span>
                    </div>
                </div>

            {% else %}
                <!-- –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
                <div class="empty-cart">
                    <div class="empty-cart-icon">üõí</div>
                    <h2>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
                    <p>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</p>
                    <button class="continue-shopping-btn" onclick="goToCatalog()">
                        üõçÔ∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–∞–º
                    </button>
                </div>
            {% endif %}
        </div>

        <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã) -->
        {% if cart_items %}
        <div class="cart-bottom-actions">
            <button class="cart-action-btn clear-cart-btn" onclick="clearCart()">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
            </button>
            <button class="cart-action-btn checkout-btn" onclick="checkout()">
                üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
            </button>
        </div>
        {% endif %}
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            window.currentUserId = tg.initDataUnsafe?.user?.id || 'demo_user';
            
            {% if cart_items %}
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
            tg.MainButton.text = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ({{ "{:,.0f}".format(total) }} {{ currency }})';
            tg.MainButton.show();
            tg.MainButton.onClick(() => checkout());
            {% endif %}
        }



        function removeFromCart(productId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) {
                console.log('Removing from cart:', productId);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
                fetch('/api/remove-from-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: 'demo_user',
                        product_id: productId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞');
                });
            }
        }

        function clearCart() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) {
                console.log('Clearing cart');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—á–∏—Å—Ç–∫—É –∫–æ—Ä–∑–∏–Ω—ã
                fetch('/api/clear-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: 'demo_user'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã');
                });
            }
        }

        function checkout() {
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
            alert('–§—É–Ω–∫—Ü–∏—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ');
        }

        function goToCatalog() {
            window.location.href = '/';
        }

        function goBack() {
            goToCatalog();
        }
    </script>
</body>
</html>
